# 默认工作项类型导致跨项目查询失败

## 问题概述

当调用 MCP 工具（如 `get_tasks`）且不指定 `work_item_type` 参数时，系统默认使用 `"问题管理"` 类型。如果目标项目中不存在该类型，会导致查询失败并返回模糊的 `"系统内部错误"` 提示。

## 影响范围

| 工具 | 位置 | 问题描述 |
|------|------|----------|
| `get_tasks` | line 336 | 有 `work_item_type` 参数，但默认值 `"问题管理"` 可能不存在 |
| `filter_tasks` | line 450 | 无 `work_item_type` 参数，硬编码使用默认值 |
| `create_task` | line 218 | 无 `work_item_type` 参数 |
| `update_task` | line 548 | 无 `work_item_type` 参数 |
| `get_task_options` | line 609 | 无 `work_item_type` 参数 |

## 问题根因

### 1. 硬编码的默认值

```python
# src/providers/project/work_item_provider.py:27
work_item_type_name: str = "问题管理",
```

### 2. 异常信息被吞没

```python
# src/mcp_server.py:390-397
except Exception as e:
    logger.critical(...)
    return "获取任务列表失败: 系统内部错误"  # 原始错误信息丢失
```

`MetadataManager.get_type_key()` 抛出的异常包含可用类型列表，但在 MCP 层被统一替换为 `"系统内部错误"`。

### 3. 执行流程

```
get_tasks(project="Project Management")
    ↓ work_item_type=None
_create_provider(project, None)
    ↓ 使用默认值 "问题管理"
WorkItemProvider(work_item_type_name="问题管理")
    ↓
MetadataManager.get_type_key("问题管理")
    ↓ 项目中无此类型
抛出 Exception("工作项类型 '问题管理' 未找到。可用类型: [...]")
    ↓ 异常被捕获
返回 "获取任务列表失败: 系统内部错误"
```

## 解决方案

### 方案 1: 动态检测（推荐）

当默认类型不存在时，自动使用项目中的第一个可用类型：

```python
# work_item_provider.py: _get_type_key 增加 fallback 逻辑
async def _get_type_key(self) -> str:
    project_key = await self._get_project_key()
    try:
        return await self.meta.get_type_key(project_key, self.work_item_type_name)
    except Exception:
        if self.work_item_type_name == "问题管理":
            types = await self.meta.list_types(project_key)
            if types:
                first_type = next(iter(types.keys()))
                logger.warning(f"默认类型 '问题管理' 不存在，使用 '{first_type}' 替代")
                return types[first_type]
        raise
```

### 方案 2: 错误透传

将类型相关错误信息透传给用户：

```python
# mcp_server.py 修改异常处理
except Exception as e:
    error_msg = str(e)
    if "工作项类型" in error_msg and "可用类型" in error_msg:
        return f"获取任务列表失败: {error_msg}"
    logger.critical(...)
    return "获取任务列表失败: 系统内部错误"
```

### 方案 3: 为所有工具添加 work_item_type 参数

为 `filter_tasks`、`create_task`、`update_task`、`get_task_options` 添加可选的 `work_item_type` 参数，保持 API 一致性。

## 优先级

**P1** - 影响跨项目操作的核心功能

## 相关文件

- `src/mcp_server.py`
- `src/providers/project/work_item_provider.py`
- `src/providers/project/managers/metadata_manager.py`

## 创建时间

2026-01-14
