# ä»£ç å®¡æŸ¥ï¼šé€»è¾‘æ¼æ´ä¸å®‰å…¨éšæ‚£åˆ†ææŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2026-01-14  
**å®¡æŸ¥èŒƒå›´**: `src/` ç›®å½•å…¨éƒ¨ä»£ç   
**å®¡æŸ¥é‡ç‚¹**: é€»è¾‘æ¼æ´ã€å®‰å…¨éšæ‚£ã€å¼‚å¸¸å´©æºƒç‚¹ã€æ€§èƒ½é—®é¢˜  

---

## 1. ä¸¥é‡å®‰å…¨é—®é¢˜ (Critical)

### 1.1 è®¤è¯ä»¤ç‰Œè¿‡æœŸæ£€æŸ¥ç¼ºå¤±

**æ–‡ä»¶**: `src/core/auth.py`  
**ä½ç½®**: ç¬¬32-34è¡Œ  

```python
# 1. Check if a static token is provided (backward compatibility)
if settings.FEISHU_PROJECT_USER_TOKEN:
    return settings.FEISHU_PROJECT_USER_TOKEN
```

**é—®é¢˜**:  
- é™æ€ä»¤ç‰Œæ²¡æœ‰è¿‡æœŸæ£€æŸ¥æœºåˆ¶
- å¦‚æœä»¤ç‰Œè¿‡æœŸï¼Œæ‰€æœ‰APIè°ƒç”¨å°†å¤±è´¥ï¼Œä½†é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®
- ä¸åŠ¨æ€è·å–çš„æ’ä»¶ä»¤ç‰Œé€»è¾‘ä¸ä¸€è‡´ï¼ˆåŠ¨æ€ä»¤ç‰Œæœ‰ç¼“å­˜è¿‡æœŸæ£€æŸ¥ï¼‰

**é£é™©**: ç”Ÿäº§ç¯å¢ƒä¸­ä»¤ç‰Œè¿‡æœŸå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œéš¾ä»¥æ’æŸ¥

**å»ºè®®**:  
```python
# å¢åŠ ä»¤ç‰Œæœ‰æ•ˆæ€§æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
if settings.FEISHU_PROJECT_USER_TOKEN:
    # å¯ä»¥æ·»åŠ ç®€å•çš„æ ¼å¼æ£€æŸ¥æˆ–è°ƒç”¨æµ‹è¯•APIéªŒè¯
    # æˆ–è€…è‡³å°‘è®°å½•è­¦å‘Šæç¤ºç”¨æˆ·æ­¤ä»¤ç‰Œå¯èƒ½è¿‡æœŸ
    logger.warning("Using static FEISHU_PROJECT_USER_TOKEN, expiration not checked")
    return settings.FEISHU_PROJECT_USER_TOKEN
```

### 1.2 æ•æ„Ÿä¿¡æ¯æ—¥å¿—æ³„éœ²

**æ–‡ä»¶**: å¤šä¸ªæ–‡ä»¶  
**ä½ç½®**: æ—¥å¿—è®°å½•æ•æ„Ÿæ•°æ®

1. **`src/providers/project/api/work_item.py`** ç¬¬27-29è¡Œ:
```python
logger.info("Creating work item: project_key=%s, type_key=%s, name=%s",
           project_key, work_item_type_key, name)
logger.debug("Field value pairs: %s", field_value_pairs)
```

2. **`src/mcp_server.py`** ç¬¬186-193è¡Œ:
```python
logger.info(
    "Creating task: project=%s, name=%s, priority=%s, assignee=%s",
    project,
    name,
    priority,
    assignee,
)
```

**é—®é¢˜**:  
- å·¥ä½œé¡¹å†…å®¹ã€é¡¹ç›®å¯†é’¥ã€ç”¨æˆ·ä¿¡æ¯ç­‰æ•æ„Ÿæ•°æ®è¢«è®°å½•åˆ°æ—¥å¿—
- æ—¥å¿—æ–‡ä»¶å¯èƒ½æœªå—ä¿æŠ¤ï¼Œå­˜åœ¨ä¿¡æ¯æ³„éœ²é£é™©

**å»ºè®®**:  
- å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œè„±æ•å¤„ç†ï¼ˆå¦‚ä»…è®°å½•å‰å‡ ä½æˆ–å“ˆå¸Œå€¼ï¼‰
- ç¡®ä¿æ—¥å¿—æ–‡ä»¶æƒé™é€‚å½“
- è€ƒè™‘ä¸åŒç¯å¢ƒçš„æ—¥å¿—çº§åˆ«ç­–ç•¥

---

## 2. é€»è¾‘æ¼æ´ä¸ç«æ€æ¡ä»¶ (High)

### 2.1 ç¼“å­˜ç«æ€æ¡ä»¶

**æ–‡ä»¶**: `src/providers/project/managers/metadata_manager.py`  

**é—®é¢˜æ¨¡å¼**: "æ£€æŸ¥-ç„¶å-æ‰§è¡Œ"æ¨¡å¼å­˜åœ¨ç«æ€æ¡ä»¶

**ç¤ºä¾‹1**: `get_project_key` æ–¹æ³•ï¼ˆç¬¬168-225è¡Œï¼‰
```python
# ç¬¬ä¸€é‡æ£€æŸ¥ (æ— é”ï¼Œå¿«é€Ÿè·¯å¾„)
if project_name in self._project_cache:
    # æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
    if not self._is_cache_expired(self._project_last_loaded, self.PROJECT_TTL):
        logger.debug(f"Cache hit: project_name='{project_name}'")
        return self._project_cache[project_name]
    # ç¼“å­˜è¿‡æœŸï¼Œç»§ç»­æ‰§è¡ŒåŠ è½½é€»è¾‘

# ç¬¬äºŒé‡æ£€æŸ¥ (åŠ é”ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶)
async with self._project_lock:
    # æ£€æŸ¥ç¼“å­˜è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™æ¸…ç©ºç¼“å­˜
    if self._is_cache_expired(self._project_last_loaded, self.PROJECT_TTL):
        self._project_cache.clear()
        self._project_last_loaded = None

    # åœ¨é”å†…å†æ¬¡æ£€æŸ¥ï¼Œé¿å…é‡å¤åŠ è½½
    if project_name in self._project_cache:
        return self._project_cache[project_name]
```

**æ¼æ´**:  
çº¿ç¨‹Aå’Œçº¿ç¨‹BåŒæ—¶è°ƒç”¨`get_project_key("åŒä¸€é¡¹ç›®")`ï¼š
1. çº¿ç¨‹Aå‘ç°ç¼“å­˜è¿‡æœŸï¼Œè¿›å…¥åŠ é”åŒºåŸŸ
2. çº¿ç¨‹Bä¹Ÿå‘ç°ç¼“å­˜è¿‡æœŸï¼Œç­‰å¾…é”
3. çº¿ç¨‹Aæ¸…ç©ºç¼“å­˜ï¼ŒåŠ è½½æ•°æ®ï¼Œæ›´æ–°ç¼“å­˜
4. çº¿ç¨‹Bè·å¾—é”ï¼Œå†æ¬¡æ£€æŸ¥ç¼“å­˜ï¼ˆæ­¤æ—¶å·²æœ‰æ•°æ®ï¼‰ï¼Œç›´æ¥è¿”å›

**ä½†å­˜åœ¨æ›´ä¸¥é‡çš„é—®é¢˜**:  
å¦‚æœçº¿ç¨‹Aåœ¨åŠ è½½æ•°æ®æ—¶å¼‚å¸¸ï¼ˆAPIè°ƒç”¨å¤±è´¥ï¼‰ï¼Œç¼“å­˜è¢«æ¸…ç©ºä½†æœªæ›´æ–°ï¼Œçº¿ç¨‹Bå°†é‡æ–°åŠ è½½ï¼Œè¿™æ˜¯æ­£ç¡®çš„ã€‚ä½†`_is_cache_expired`æ£€æŸ¥åŸºäº`_project_last_loaded`ï¼Œå¦‚æœAåŠ è½½å¤±è´¥ï¼Œè¯¥å€¼ä»ä¸ºNoneæˆ–æ—§å€¼ï¼ŒBä¼šå†æ¬¡å°è¯•åŠ è½½ã€‚

**å»ºè®®**: ä½¿ç”¨"ä»¤ç‰Œä¼ é€’"æ¨¡å¼æˆ–æ›´ä¸¥æ ¼çš„å¼‚å¸¸å¤„ç†

### 2.2 å¼‚å¸¸å¤„ç†è¿‡äºå®½æ³›

**æ–‡ä»¶**: å¤šå¤„ä½¿ç”¨`except Exception`  

**é«˜é£é™©ä½ç½®**:

1. **`src/mcp_server.py`** ç¬¬141-143è¡Œ:
```python
except Exception as e:
    logger.error("Failed to list projects: %s", e, exc_info=True)
    return f"è·å–é¡¹ç›®åˆ—è¡¨å¤±è´¥: {str(e)}"
```

2. **`src/providers/project/work_item_provider.py`** ç¬¬76-78è¡Œ:
```python
except Exception as e:
    logger.debug(f"Field '{field_name}' not found: {e}")
    return False
```

**é—®é¢˜**:  
- æ•è·æ‰€æœ‰å¼‚å¸¸å¯èƒ½æ©ç›–å…³é”®é”™è¯¯ï¼ˆå¦‚KeyboardInterruptã€SystemExitï¼‰
- è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯ä¸åˆ©äºè°ƒè¯•
- æŸäº›ä½ç½®åº”è¯¥è®©å¼‚å¸¸å‘ä¸Šä¼ æ’­

**å»ºè®®**:  
- æ˜ç¡®æ•è·ç‰¹å®šå¼‚å¸¸ç±»å‹
- å¯¹éœ€è¦å¤„ç†çš„å¼‚å¸¸è¿›è¡Œåˆ†ç±»
- é‡è¦é”™è¯¯åº”è¯¥é‡æ–°æŠ›å‡ºæˆ–è®°å½•æ›´è¯¦ç»†çš„ä¿¡æ¯

---

## 3. å†…å­˜ä¸èµ„æºæ³„æ¼é£é™© (High)

### 3.1 ç¼“å­˜æ— é™å¢é•¿

**æ–‡ä»¶**: `src/providers/project/managers/metadata_manager.py`  

**é—®é¢˜**: æ‰€æœ‰ç¼“å­˜å­—å…¸éƒ½æ²¡æœ‰å¤§å°é™åˆ¶æˆ–LRUæœºåˆ¶

- `_project_cache`: é¡¹ç›®åç§° -> é¡¹ç›®Key
- `_type_cache`: é¡¹ç›®Key -> {ç±»å‹åç§° -> ç±»å‹Key}  
- `_field_cache`: é¡¹ç›®Key -> ç±»å‹Key -> {å­—æ®µåç§° -> å­—æ®µKey}
- `_option_cache`: é¡¹ç›®Key -> ç±»å‹Key -> å­—æ®µKey -> {æ ‡ç­¾ -> å€¼}
- `_user_cache`: æ ‡è¯†ç¬¦ -> ç”¨æˆ·Key

**é£é™©**:  
- é•¿æœŸè¿è¡Œçš„æœåŠ¡å¯èƒ½ç§¯ç´¯å¤§é‡ç¼“å­˜æ•°æ®
- å¤šé¡¹ç›®ã€å¤šç±»å‹ç¯å¢ƒä¸‹å†…å­˜å ç”¨å¯èƒ½å¤±æ§
- ç¼“å­˜TTLåªè§£å†³æ—¶æ•ˆæ€§é—®é¢˜ï¼Œä¸è§£å†³å®¹é‡é—®é¢˜

**å»ºè®®**:  
- å®ç°LRUç¼“å­˜æˆ–è®¾ç½®æœ€å¤§æ¡ç›®é™åˆ¶
- å®šæœŸæ¸…ç†é•¿æ—¶é—´æœªè®¿é—®çš„æ¡ç›®
- è€ƒè™‘ä½¿ç”¨ä¸“ä¸šç¼“å­˜åº“ï¼ˆå¦‚`cachetools`ï¼‰

### 3.2 HTTPå®¢æˆ·ç«¯æœªæ­£ç¡®å…³é—­

**æ–‡ä»¶**: `src/core/project_client.py`  

**é—®é¢˜**: `ProjectClient`ç±»æ²¡æœ‰åœ¨`__del__`æˆ–ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ç¡®ä¿å…³é—­

```python
async def close(self):
    """å…³é—­å®¢æˆ·ç«¯è¿æ¥"""
    logger.info("Closing ProjectClient connection")
    await self.client.aclose()
    logger.debug("ProjectClient connection closed")
```

**é£é™©**:  
- å•ä¾‹æ¨¡å¼ä¸‹çš„å®¢æˆ·ç«¯å¯èƒ½åœ¨æ•´ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸå†…ä¸å…³é—­
- å¼‚æ­¥HTTPè¿æ¥æ± å¯èƒ½æ³„æ¼
- ç¨‹åºå¼‚å¸¸é€€å‡ºæ—¶èµ„æºæœªæ¸…ç†

**å»ºè®®**:  
- å®ç°`__aenter__`/`__aexit__`æ”¯æŒå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- åœ¨åº”ç”¨å…³é—­æ—¶æ˜¾å¼è°ƒç”¨`close()`
- è€ƒè™‘ä½¿ç”¨`atexit`æ³¨å†Œæ¸…ç†å‡½æ•°

---

## 4. æ€§èƒ½ç“¶é¢ˆ (Medium)

### 4.1 Related_toæŸ¥è¯¢çš„å…¨é‡æ‰«æ

**æ–‡ä»¶**: `src/providers/project/work_item_provider.py`  
**ä½ç½®**: ç¬¬600-679è¡Œ

**é—®é¢˜**:  
```python
# ç‰¹æ®Šå¤„ç†ï¼šå½“åªæœ‰ related_to å‚æ•°æ—¶ï¼Œéœ€è¦è·å–æ‰€æœ‰å·¥ä½œé¡¹è¿›è¡Œå®¢æˆ·ç«¯è¿‡æ»¤
if (
    related_to
    and not name_keyword
    and not status
    and not priority
    and not owner
):
    logger.info(f"Getting all items for related_to filtering: {related_to}")

    all_items = []
    current_page = 1
    batch_size = 100

    while True:
        # å¾ªç¯è·å–æ‰€æœ‰é¡µé¢...
```

**æ€§èƒ½å½±å“**:  
- å¤§æ•°æ®é›†ä¸‹éœ€è¦å¤šæ¬¡APIè°ƒç”¨ï¼ˆæ¯é¡µ100æ¡ï¼‰
- å®¢æˆ·ç«¯è¿‡æ»¤O(n)å¤æ‚åº¦
- å†…å­˜å ç”¨é«˜ï¼ˆéœ€è¦åŠ è½½æ‰€æœ‰å·¥ä½œé¡¹åˆ°å†…å­˜ï¼‰

**ä¼˜åŒ–å»ºè®®**:  
1. **å¢é‡åŠ è½½ä¸è¿‡æ»¤**: è¾¹åŠ è½½è¾¹è¿‡æ»¤ï¼Œæ»¡è¶³æ•°é‡è¦æ±‚åç«‹å³åœæ­¢
2. **ç¼“å­˜å…³è”å…³ç³»**: å»ºç«‹å·¥ä½œé¡¹å…³è”å…³ç³»çš„æœ¬åœ°ç¼“å­˜
3. **å¼‚æ­¥æµå¼å¤„ç†**: ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨å‡å°‘å†…å­˜å ç”¨
4. **é…ç½®åŒ–é™åˆ¶**: å…è®¸ç”¨æˆ·è®¾ç½®æœ€å¤§æ‰«ææ•°é‡

### 4.2 é‡å¤çš„å…ƒæ•°æ®åŠ è½½

**æ–‡ä»¶**: `src/providers/project/managers/metadata_manager.py`  

**é—®é¢˜**: `_ensure_field_cache`å¯èƒ½è¢«é¢‘ç¹è°ƒç”¨ï¼Œå³ä½¿ç¼“å­˜æœªè¿‡æœŸ

```python
async def _ensure_field_cache(self, project_key: str, type_key: str) -> None:
    # ç¬¬ä¸€é‡æ£€æŸ¥ (æ— é”ï¼Œå¿«é€Ÿè·¯å¾„)
    if (
        project_key in self._field_cache
        and type_key in self._field_cache[project_key]
    ):
        # æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
        last_loaded = self._field_last_loaded.get(project_key, {}).get(type_key)
        if not self._is_cache_expired(last_loaded, self.FIELD_TTL):
            return
        # ç¼“å­˜è¿‡æœŸï¼Œç»§ç»­æ‰§è¡ŒåŠ è½½é€»è¾‘
```

**ä¼˜åŒ–å»ºè®®**:  
- ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼ˆå¦‚åµŒå¥—çš„defaultdictï¼‰
- å‡å°‘é”ç«äº‰ï¼ˆè€ƒè™‘è¯»å†™é”ï¼‰
- é¢„åŠ è½½å¸¸ç”¨é¡¹ç›®çš„å…ƒæ•°æ®

---

## 5. æ•°æ®ä¸€è‡´æ€§ä¸å®Œæ•´æ€§é£é™© (Medium)

### 5.1 å·¥ä½œé¡¹åˆ›å»ºä¸æ›´æ–°çš„åŸå­æ€§é—®é¢˜

**æ–‡ä»¶**: `src/providers/project/work_item_provider.py`  
**ä½ç½®**: `create_issue` æ–¹æ³•ï¼ˆç¬¬263-327è¡Œï¼‰

**é—®é¢˜**: åˆ›å»ºåæ›´æ–°ä¼˜å…ˆçº§çš„æ¨¡å¼
```python
# 2. Create Work Item
issue_id = await self.api.create(project_key, type_key, name, create_fields)

# 3. Update Priority (if needed)
# Note: Priority cannot be set during creation for some reason, so we update it after.
if priority:
    try:
        field_key = await self.meta.get_field_key(
            project_key, type_key, "priority"
        )
        option_val = await self._resolve_field_value(
            project_key, type_key, field_key, priority
        )

        logger.info(f"Updating priority to {option_val}...")
        await self.api.update(
            project_key,
            type_key,
            issue_id,
            [{"field_key": field_key, "field_value": option_val}],
        )
    except Exception as e:
        logger.warning(f"Failed to update priority: {e}")
```

**é£é™©**:  
- åˆ›å»ºå·¥ä½œé¡¹æˆåŠŸï¼Œä½†ä¼˜å…ˆçº§æ›´æ–°å¤±è´¥
- å·¥ä½œé¡¹å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼ˆæœ‰æ ‡é¢˜ä½†æ— æ­£ç¡®ä¼˜å…ˆçº§ï¼‰
- æ— å›æ»šæˆ–è¡¥å¿æœºåˆ¶

**å»ºè®®**:  
1. **äº‹åŠ¡æ€§å°è¯•**: å…ˆå°è¯•åœ¨åˆ›å»ºæ—¶è®¾ç½®æ‰€æœ‰å­—æ®µï¼Œå¤±è´¥å†å›é€€åˆ°ä¸¤é˜¶æ®µ
2. **çŠ¶æ€æ ‡è®°**: æ ‡è®°æœªå®Œæ•´è®¾ç½®çš„å·¥ä½œé¡¹
3. **åå°ä¿®å¤**: å®šæœŸæ£€æŸ¥å¹¶ä¿®å¤ä¸ä¸€è‡´çš„å·¥ä½œé¡¹

### 5.2 ç”¨æˆ·Keyè§£æçš„å¯å‘å¼è§„åˆ™ä¸å¯é 

**æ–‡ä»¶**: `src/providers/project/managers/metadata_manager.py`  
**ä½ç½®**: `_looks_like_user_key` æ–¹æ³•ï¼ˆç¬¬606-640è¡Œï¼‰

```python
def _looks_like_user_key(self, identifier: str) -> bool:
    """
    åˆ¤æ–­æ ‡è¯†ç¬¦æ˜¯å¦å·²ç»æ˜¯ User Key æ ¼å¼
    
    å¯å‘å¼è§„åˆ™:
    1. ä»¥å¸¸è§çš„å‰ç¼€å¼€å¤´: "user_", "ou_", "usr_", "u_"
    2. ä¸åŒ…å«ç©ºæ ¼å’Œä¸­æ–‡
    3. é•¿åº¦é€‚ä¸­ (5-100ä¸ªå­—ç¬¦)
    """
```

**é—®é¢˜**:  
- å¯å‘å¼è§„åˆ™å¯èƒ½è¯¯åˆ¤ï¼ˆå¦‚"username@example.com"å¯èƒ½è¢«è¯¯è®¤ä¸ºuser_keyï¼‰
- è§„åˆ™å¯èƒ½æ¼åˆ¤ï¼ˆæ–°çš„user_keyæ ¼å¼ä¸è¢«è¯†åˆ«ï¼‰
- æ— æƒå¨éªŒè¯ï¼Œä»…å‡­æ ¼å¼çŒœæµ‹

**é£é™©**: é”™è¯¯çš„ç”¨æˆ·Keyå¯¼è‡´å·¥ä½œé¡¹åˆ†é…é”™è¯¯æˆ–APIè°ƒç”¨å¤±è´¥

**å»ºè®®**:  
1. **æ˜¾å¼æ ‡è®°**: è¦æ±‚ç”¨æˆ·æ˜ç¡®æŒ‡å®šæ˜¯å¦ä¸ºuser_key
2. **éªŒè¯æŸ¥è¯¢**: å°è¯•ç”¨æ ‡è¯†ç¬¦æŸ¥è¯¢ç”¨æˆ·ï¼Œæ ¹æ®ç»“æœåˆ¤æ–­
3. **é…ç½®æ˜ å°„**: ç»´æŠ¤å·²çŸ¥çš„ç”¨æˆ·æ ‡è¯†ç¬¦åˆ°user_keyçš„æ˜ å°„

---

## 6. é”™è¯¯æ¢å¤ä¸å®¹é”™æ€§é—®é¢˜ (Medium)

### 6.1 é‡è¯•æœºåˆ¶å¯èƒ½é€ æˆé‡å¤æ“ä½œ

**æ–‡ä»¶**: `src/core/project_client.py`  
**ä½ç½®**: ç¬¬107-174è¡Œ

**é—®é¢˜**: HTTPé‡è¯•æœºåˆ¶å¯¹éå¹‚ç­‰æ“ä½œæœ‰é£é™©
```python
@self._get_retry_decorator()
async def _do_request():
    # ... è¯·æ±‚é€»è¾‘
    # 5xx é”™è¯¯è§¦å‘é‡è¯•
    if _should_retry_response(response):
        logger.warning(
            "Received %d from %s, will retry...", response.status_code, path
        )
        raise RetryableHTTPError(response)
```

**é£é™©**:  
- POSTè¯·æ±‚ï¼ˆåˆ›å»ºå·¥ä½œé¡¹ï¼‰åœ¨5xxé”™è¯¯åé‡è¯•å¯èƒ½é€ æˆé‡å¤åˆ›å»º
- é£ä¹¦APIçš„æŸäº›æ“ä½œå¯èƒ½ä¸æ˜¯å¹‚ç­‰çš„

**å»ºè®®**:  
- å¯¹éå¹‚ç­‰æ“ä½œç¦ç”¨é‡è¯•æˆ–ä½¿ç”¨æ›´æ™ºèƒ½çš„é‡è¯•ç­–ç•¥
- å®ç°è¯·æ±‚å»é‡ï¼ˆidempotency keyï¼‰
- åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•çš„é”™è¯¯ç±»å‹

### 6.2 ç¼ºå°‘æ–­è·¯å™¨æ¨¡å¼

**é—®é¢˜**: å½“é£ä¹¦APIæŒç»­å¤±è´¥æ—¶ï¼Œæ²¡æœ‰æ–­è·¯å™¨æœºåˆ¶

**é£é™©**:  
- æœåŠ¡ä¸å¯ç”¨æ—¶æŒç»­é‡è¯•ï¼Œæµªè´¹èµ„æº
- å¯èƒ½è§¦å‘APIé™æµ
- é”™è¯¯ä¼ æ’­åˆ°ä¸Šå±‚æœåŠ¡

**å»ºè®®**: å®ç°ç®€å•çš„æ–­è·¯å™¨æ¨¡å¼æˆ–ä½¿ç”¨`tenacity`çš„`circuit_breaker`

---

## 7. é…ç½®ä¸éƒ¨ç½²é£é™© (Low)

### 7.1 ç¯å¢ƒå˜é‡ç¼ºå°‘éªŒè¯

**æ–‡ä»¶**: `src/core/config.py`  

**é—®é¢˜**: Pydanticè®¾ç½®ç±»åªåšåŸºç¡€ç±»å‹æ£€æŸ¥ï¼Œç¼ºå°‘ä¸šåŠ¡é€»è¾‘éªŒè¯

```python
class Settings(BaseSettings):
    LARK_APP_ID: str
    LARK_APP_SECRET: str
    LARK_ENCRYPT_KEY: str | None = None
    # ...
```

**é£é™©**:  
- æ— æ•ˆçš„é…ç½®å¯¼è‡´è¿è¡Œæ—¶å¤±è´¥
- æ•æ„Ÿé…ç½®ä»¥æ˜æ–‡å½¢å¼è®°å½•åœ¨`.env`æ–‡ä»¶ä¸­
- ç¼ºå°‘é…ç½®é—´çš„ä¾èµ–å…³ç³»æ£€æŸ¥

**å»ºè®®**:  
- æ·»åŠ è‡ªå®šä¹‰éªŒè¯å™¨
- é‡è¦é…ç½®é¡¹æä¾›é»˜è®¤å€¼æˆ–æ˜ç¡®çš„é”™è¯¯æç¤º
- è€ƒè™‘ä½¿ç”¨åŠ å¯†çš„é…ç½®å­˜å‚¨

### 7.2 ç¼ºå°‘å¥åº·æ£€æŸ¥ä¸ç›‘æ§

**é—®é¢˜**: æ— å†…ç½®çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹æˆ–ç›‘æ§æŒ‡æ ‡

**é£é™©**:  
- éš¾ä»¥åˆ¤æ–­æœåŠ¡çŠ¶æ€
- æ•…éšœæ£€æµ‹å»¶è¿Ÿ
- æ€§èƒ½é—®é¢˜éš¾ä»¥åŠæ—¶å‘ç°

**å»ºè®®**:  
- æ·»åŠ `/health`ç«¯ç‚¹
- é›†æˆPrometheusæŒ‡æ ‡
- å…³é”®æ“ä½œæ·»åŠ æ€§èƒ½ç›‘æ§

---

## 8. æ€»ç»“ä¸ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³ä¿®å¤ (P0)
1. **è®¤è¯ä»¤ç‰Œè¿‡æœŸå¤„ç†** - é¿å…æœåŠ¡ä¸å¯ç”¨
2. **æ•æ„Ÿä¿¡æ¯æ—¥å¿—è„±æ•** - å®‰å…¨åˆè§„è¦æ±‚
3. **ç¼“å­˜ç«æ€æ¡ä»¶ä¿®å¤** - æ•°æ®ä¸€è‡´æ€§é£é™©

### çŸ­æœŸä¼˜åŒ– (P1)
1. **å†…å­˜æ³„æ¼é£é™©** - æ·»åŠ ç¼“å­˜å¤§å°é™åˆ¶
2. **å¼‚å¸¸å¤„ç†ç»†åŒ–** - æé«˜å¯è°ƒè¯•æ€§
3. **HTTPå®¢æˆ·ç«¯èµ„æºç®¡ç†** - é¿å…è¿æ¥æ³„æ¼

### ä¸­æœŸæ”¹è¿› (P2)
1. **æ€§èƒ½ç“¶é¢ˆä¼˜åŒ–** - related_toæŸ¥è¯¢ä¼˜åŒ–
2. **æ•°æ®ä¸€è‡´æ€§ä¿éšœ** - å·¥ä½œé¡¹åˆ›å»ºåŸå­æ€§
3. **é”™è¯¯æ¢å¤æœºåˆ¶** - æ–­è·¯å™¨æ¨¡å¼

### é•¿æœŸè§„åˆ’ (P3)
1. **é…ç½®éªŒè¯å¢å¼º**
2. **ç›‘æ§ä¸å¯è§‚æµ‹æ€§**
3. **æµ‹è¯•è¦†ç›–ç‡æå‡**

---

## 9. æœ€æ–°ä»£ç å˜æ›´å¼•å…¥çš„é—®é¢˜ (2026-01-14)

**å˜æ›´èƒŒæ™¯**: ä¿®å¤é»˜è®¤å·¥ä½œé¡¹ç±»å‹å¯¼è‡´è·¨é¡¹ç›®æŸ¥è¯¢å¤±è´¥çš„é—®é¢˜  
**å—å½±å“æ–‡ä»¶**: `src/mcp_server.py`, `src/providers/project/work_item_provider.py`

### ğŸ”´ é«˜å±é—®é¢˜ (Critical)

#### 9.1 æ•æ„Ÿä¿¡æ¯æ³„éœ²é£é™©

**æ–‡ä»¶**: `src/mcp_server.py:56-78`  
**ä½ç½®**: `_should_expose_error` å‡½æ•°

```python
def _should_expose_error(error_msg: str) -> bool:
    # é—®é¢˜ï¼šå¯èƒ½é€ä¼ åŒ…å«å¯†é’¥çš„å®Œæ•´é”™è¯¯ä¿¡æ¯
    if "é¡¹ç›®" in error_msg and "æœªæ‰¾åˆ°" in error_msg:
        return True  # å¯èƒ½è¿”å› "é¡¹ç›®å¯†é’¥ 'project_secret_xxx' æœªæ‰¾åˆ°"
```

**é£é™©**: 
- å½“é”™è¯¯ä¿¡æ¯åŒ…å«"é¡¹ç›®"å’Œ"æœªæ‰¾åˆ°"æ—¶ï¼Œä¼šé€ä¼ å®Œæ•´é”™è¯¯ä¿¡æ¯
- å¯èƒ½æš´éœ² project_keyã€APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯åˆ°å®¢æˆ·ç«¯
- æ”»å‡»è€…å¯é€šè¿‡é”™è¯¯ä¿¡æ¯æ”¶é›†å†…éƒ¨ç³»ç»Ÿä¿¡æ¯

**å»ºè®®**:
```python
def _mask_sensitive_in_error(error_msg: str) -> str:
    """å¯¹é”™è¯¯ä¿¡æ¯ä¸­çš„æ•æ„Ÿæ•°æ®è¿›è¡Œè„±æ•"""
    # æ›¿æ¢ project_key
    import re
    error_msg = re.sub(r"project_[a-zA-Z0-9_]+", "project_***", error_msg)
    # æ›¿æ¢å¯èƒ½çš„å¯†é’¥
    error_msg = re.sub(r"[a-fA-F0-9]{32,}", "***", error_msg)
    return error_msg
```

#### 9.2 ç«æ€æ¡ä»¶å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

**æ–‡ä»¶**: `src/providers/project/work_item_provider.py:71-81`  
**ä½ç½®**: `_get_type_key` æ–¹æ³•ä¸­çš„çŠ¶æ€ä¿®æ”¹

```python
if self.work_item_type_name == "é—®é¢˜ç®¡ç†":
    types = await self.meta.list_types(project_key)
    if types:
        first_type_name = next(iter(types.keys()))
        self.work_item_type_name = first_type_name  # å¹¶å‘ä¿®æ”¹ï¼
```

**é£é™©**:
- å¤šä¸ªåç¨‹åŒæ—¶è§¦å‘ fallback æ—¶ï¼Œä¼šå¹¶å‘ä¿®æ”¹ `self.work_item_type_name`
- å¯¼è‡´åŒä¸€ä¸ª provider å®ä¾‹åœ¨ä¸åŒåç¨‹ä¸­ä½¿ç”¨ä¸ä¸€è‡´çš„ç±»å‹
- åç»­ API è°ƒç”¨å¯èƒ½ä½¿ç”¨é”™è¯¯çš„å­—æ®µæ˜ å°„

**å»ºè®®**:
```python
import asyncio

class WorkItemProvider(Provider):
    def __init__(self, ...):
        # ...
        self._type_lock = asyncio.Lock()
    
    async def _get_type_key(self) -> str:
        async with self._type_lock:
            # åœ¨é”ä¿æŠ¤ä¸‹æ£€æŸ¥å’Œä¿®æ”¹çŠ¶æ€
            if self.work_item_type_name == "é—®é¢˜ç®¡ç†" and hasattr(self, '_fallback_type'):
                return self._fallback_type
            # ... fallback é€»è¾‘
            self._fallback_type = first_type_key
```

### ğŸŸ¡ ä¸­å±é—®é¢˜ (Medium)

#### 9.3 å¼‚å¸¸å¤„ç†è¿‡äºå®½æ³›

**æ–‡ä»¶**: `src/providers/project/work_item_provider.py:67`  
**ä½ç½®**: `_get_type_key` ä¸­çš„å¼‚å¸¸æ•è·

```python
try:
    return await self.meta.get_type_key(project_key, self.work_item_type_name)
except Exception as e:  # æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œå¯èƒ½æ©ç›–ä¸¥é‡é”™è¯¯
```

**é£é™©**:
- `Exception` åŸºç±»ä¼šæ•è· `KeyboardInterrupt`ã€`SystemExit` ç­‰ç³»ç»Ÿçº§å¼‚å¸¸
- å¯¼è‡´ç¨‹åºæ— æ³•æ­£å¸¸ç»ˆæ­¢
- å¯èƒ½æ©ç›–åº•å±‚ä¸¥é‡çš„ç³»ç»Ÿé”™è¯¯

**å»ºè®®**:
```python
try:
    return await self.meta.get_type_key(project_key, self.work_item_type_name)
except (ValueError, KeyError) as e:
    # åªæ•è·é¢„æœŸçš„ä¸šåŠ¡å¼‚å¸¸
    # ...
except Exception as e:
    # è®°å½•ä½†é‡æ–°æŠ›å‡ºæœªçŸ¥å¼‚å¸¸
    logger.error("Unexpected error getting type key: %s", e)
    raise
```

#### 9.4 é”™è¯¯é€ä¼ é€»è¾‘è¿‡äºä¸¥æ ¼

**æ–‡ä»¶**: `src/mcp_server.py:70-77`  
**ä½ç½®**: `_should_expose_error` å‡½æ•°çš„æ¡ä»¶åˆ¤æ–­

```python
if "å·¥ä½œé¡¹ç±»å‹" in error_msg and "å¯ç”¨ç±»å‹" in error_msg:
    return True
```

**é£é™©**:
- é”™è¯¯ä¿¡æ¯ "å·¥ä½œé¡¹ç±»å‹ 'éœ€æ±‚ç®¡ç†' ä¸å­˜åœ¨" ä¸åŒ…å«"å¯ç”¨ç±»å‹"ï¼Œä¸ä¼šé€ä¼ 
- ç”¨æˆ·æ— æ³•è·å¾—æœ‰ç”¨ä¿¡æ¯ï¼Œä»ç„¶çœ‹åˆ°æ¨¡ç³Šçš„"ç³»ç»Ÿå†…éƒ¨é”™è¯¯"
- ä¿®å¤çš„ç›®çš„è¢«éƒ¨åˆ†ç ´å

**å»ºè®®**:
```python
def _should_expose_error(error_msg: str) -> bool:
    # æ”¾å®½æ¡ä»¶ï¼šåªè¦åŒ…å«å…³é”®ä¸šåŠ¡ä¿¡æ¯å°±é€ä¼ 
    business_errors = [
        "å·¥ä½œé¡¹ç±»å‹",
        "é¡¹ç›®",
        "ç”¨æˆ·",
        "å­—æ®µ",
        "é€‰é¡¹",
        "æƒé™",
        "ä¸å­˜åœ¨",
        "æœªæ‰¾åˆ°",
        "æ— æ•ˆ",
        "ä¸å…è®¸"
    ]
    
    # æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•ä¸šåŠ¡é”™è¯¯å…³é”®è¯
    for keyword in business_errors:
        if keyword in error_msg:
            return True
    
    # æ£€æŸ¥æ˜¯å¦åŒ…å«å †æ ˆè·Ÿè¸ªï¼ˆåº”è¯¥éšè—ï¼‰
    stack_trace_indicators = ["File \"", "line ", "Traceback", "at 0x"]
    for indicator in stack_trace_indicators:
        if indicator in error_msg:
            return False
    
    return False
```

#### 9.5 å †æ ˆè·Ÿè¸ªæ³„éœ²

**å¤šä¸ªä½ç½®**ä½¿ç”¨ `str(e)` è¿”å›å®Œæ•´å¼‚å¸¸ä¿¡æ¯

**é£é™©**:
- å¼‚å¸¸ `str(e)` å¯èƒ½åŒ…å«å®Œæ•´è°ƒç”¨å †æ ˆ
- æš´éœ²å†…éƒ¨å®ç°ç»†èŠ‚ã€æ–‡ä»¶è·¯å¾„ã€å‡½æ•°å
- æ”»å‡»è€…å¯é€šè¿‡å †æ ˆä¿¡æ¯æ¨æ–­ç³»ç»Ÿæ¶æ„

**å»ºè®®**:
```python
def _extract_error_message(e: Exception) -> str:
    """ä»å¼‚å¸¸ä¸­æå–å®‰å…¨çš„é”™è¯¯æ¶ˆæ¯"""
    error_str = str(e)
    # ç§»é™¤å †æ ˆè·Ÿè¸ª
    lines = error_str.split('\n')
    safe_lines = []
    for line in lines:
        if line.strip().startswith('File "'):
            break
        if line.strip().startswith('Traceback'):
            break
        safe_lines.append(line)
    return ' '.join(safe_lines[:3])  # åªè¿”å›å‰3è¡Œ
```

#### 9.6 ç±»å‹æ¨æ–­å¯èƒ½å¯¼è‡´é”™è¯¯æ“ä½œ

**é£é™©**: `update_task(issue_id, work_item_type="éœ€æ±‚ç®¡ç†")` ä½¿ç”¨æŒ‡å®šçš„ work_item_typeï¼Œä½†å®é™…å·¥ä½œé¡¹å¯èƒ½æ˜¯å…¶ä»–ç±»å‹ï¼Œå¯¼è‡´å­—æ®µæ˜ å°„é”™è¯¯ã€‚

**åœºæ™¯**:
1. å·¥ä½œé¡¹ID=123çš„ç±»å‹æ˜¯"Issueç®¡ç†"
2. è°ƒç”¨ `update_task(issue_id=123, work_item_type="éœ€æ±‚ç®¡ç†", status="å·²å®Œæˆ")`
3. Providerä½¿ç”¨"éœ€æ±‚ç®¡ç†"çš„ç±»å‹å­—æ®µæ˜ å°„
4. å®é™…APIè°ƒç”¨å¯èƒ½å¤±è´¥æˆ–è®¾ç½®é”™è¯¯å­—æ®µ

**å»ºè®®**:
```python
async def update_issue(self, issue_id: int, ...):
    # å…ˆè·å–å·¥ä½œé¡¹çš„å®é™…ç±»å‹
    actual_type = await self._get_work_item_type(issue_id)
    if work_item_type and actual_type != work_item_type:
        raise ValueError(
            f"å·¥ä½œé¡¹ {issue_id} çš„å®é™…ç±»å‹ä¸º '{actual_type}'ï¼Œ"
            f"ä¸æŒ‡å®šçš„ç±»å‹ '{work_item_type}' ä¸åŒ¹é…"
        )
    # ç»§ç»­æ›´æ–°é€»è¾‘
```

### ğŸŸ¢ ä½å±é—®é¢˜ (Low)

#### 9.7 æ–‡æ¡£ä¸å®é™…è¡Œä¸ºä¸ä¸€è‡´

**é—®é¢˜**:
- `create_task` æ–‡æ¡£ï¼š"å¦‚ä¸æŒ‡å®šï¼Œé»˜è®¤ä½¿ç”¨é¡¹ç›®ä¸­çš„ç¬¬ä¸€ä¸ªå¯ç”¨ç±»å‹"
- å®é™…è¡Œä¸ºï¼šä½¿ç”¨"é—®é¢˜ç®¡ç†"ï¼Œä»…åœ¨ä¸å­˜åœ¨æ—¶ fallback

**å½±å“**: ç”¨æˆ·æœŸæœ› vs å®é™…è¡Œä¸ºä¸åŒ¹é…ï¼Œå¯èƒ½å¯¼è‡´æ··æ·†ã€‚

**å»ºè®®**: æ›´æ–°æ–‡æ¡£æˆ–ä¿®æ”¹é»˜è®¤è¡Œä¸ºä½¿å…¶ä¸€è‡´ã€‚

#### 9.8 ç©ºå­—å…¸è¿­ä»£é£é™©

**æ–‡ä»¶**: `src/providers/project/work_item_provider.py:74`  
**ä½ç½®**: `next(iter(types.keys()))`

```python
first_type_name = next(iter(types.keys()))  # å¦‚æœ types åœ¨ if æ£€æŸ¥åå˜ä¸ºç©ºï¼Ÿ
```

**é£é™©**: ç†è®ºä¸Š `if types:` æ£€æŸ¥å `types` ä¸åº”ä¸ºç©ºï¼Œä½†å¼‚æ­¥ç¯å¢ƒä¸‹å¦‚æœ `types` è¢«æ„å¤–ä¿®æ”¹å¯èƒ½æŠ›å‡º `StopIteration`ã€‚

**å»ºè®®**:
```python
if types:
    try:
        first_type_name = next(iter(types.keys()))
    except StopIteration:
        # é˜²å¾¡æ€§ç¼–ç¨‹ï¼štypesåœ¨æ£€æŸ¥åå˜ä¸ºç©º
        raise ValueError(f"é¡¹ç›® {project_key} ä¸­æ²¡æœ‰å¯ç”¨çš„å·¥ä½œé¡¹ç±»å‹")
```

#### 9.9 Provider ç±»å‹çŠ¶æ€æ±¡æŸ“

**é£é™©**: fallback åä¿®æ”¹ `self.work_item_type_name`ï¼ŒåŒä¸€ä¸ª provider å®ä¾‹çš„åç»­æ“ä½œéƒ½ä¼šä½¿ç”¨æ–°ç±»å‹ï¼Œå³ä½¿åŸå§‹æ„å›¾ä¸æ˜¯è¿™æ ·ã€‚

**åœºæ™¯**:
1. Provideråˆå§‹åŒ–æ—¶ä½¿ç”¨é»˜è®¤ç±»å‹"é—®é¢˜ç®¡ç†"
2. ç¬¬ä¸€æ¬¡è°ƒç”¨è§¦å‘fallbackï¼Œä¿®æ”¹ä¸º"éœ€æ±‚ç®¡ç†"
3. åç»­æ‰€æœ‰æ“ä½œéƒ½ä½¿ç”¨"éœ€æ±‚ç®¡ç†"ï¼Œå³ä½¿æŸäº›æ“ä½œæœ¬åº”ä½¿ç”¨å…¶ä»–ç±»å‹

**å»ºè®®**:
```python
async def _get_type_key(self) -> str:
    # ä¸ä¿®æ”¹å®ä¾‹çŠ¶æ€ï¼Œä»…è¿”å›fallbackç»“æœ
    if self.work_item_type_name == "é—®é¢˜ç®¡ç†":
        types = await self.meta.list_types(project_key)
        if types:
            first_type_name = next(iter(types.keys()))
            first_type_key = types[first_type_name]
            logger.warning(f"é»˜è®¤ç±»å‹ 'é—®é¢˜ç®¡ç†' ä¸å­˜åœ¨ï¼Œä¸´æ—¶ä½¿ç”¨ '{first_type_name}'")
            return first_type_key  # ä¸ä¿®æ”¹ self.work_item_type_name
    # å…¶ä»–æƒ…å†µä½¿ç”¨åŸå§‹ç±»å‹
    return await self.meta.get_type_key(project_key, self.work_item_type_name)
```

---

## 10. æœ€æ–°å˜æ›´ä¿®å¤å»ºè®®æ€»ç»“

### ç«‹å³ä¿®å¤ (P0)
1. **æ•æ„Ÿä¿¡æ¯è„±æ•** - åœ¨ `_should_expose_error` ä¸­é€ä¼ å‰å¯¹é”™è¯¯ä¿¡æ¯è¿›è¡Œè„±æ•å¤„ç†
2. **çº¿ç¨‹å®‰å…¨** - åœ¨ `_get_type_key` ä¸­ä½¿ç”¨ `asyncio.Lock` ä¿æŠ¤çŠ¶æ€ä¿®æ”¹

### çŸ­æœŸä¼˜åŒ– (P1)
1. **ç²¾ç¡®å¼‚å¸¸æ•è·** - åªæ•è· `ValueError` ç­‰ç‰¹å®šå¼‚å¸¸ç±»å‹
2. **é”™è¯¯ä¿¡æ¯ä¼˜åŒ–** - æ”¾å®½é€ä¼ æ¡ä»¶ï¼Œæå–å¼‚å¸¸ä¸»æ¶ˆæ¯è€Œéå®Œæ•´ `str(e)`
3. **ç±»å‹éªŒè¯** - `update_task` åº”å…ˆè·å–å·¥ä½œé¡¹å®é™…ç±»å‹ï¼ŒéªŒè¯ä¸æŒ‡å®šç±»å‹æ˜¯å¦å…¼å®¹

### æ–‡æ¡£æ›´æ–° (P2)
1. **æ›´æ–°APIæ–‡æ¡£** - ç¡®ä¿æ–‡æ¡£ä¸å®é™…è¡Œä¸ºä¸€è‡´
2. **æ·»åŠ ç¤ºä¾‹** - æä¾›æ˜ç¡®çš„å·¥ä½œé¡¹ç±»å‹ä½¿ç”¨ç¤ºä¾‹

**å®¡æŸ¥ç»“è®º**: æœ€æ–°å˜æ›´è§£å†³äº†è·¨é¡¹ç›®æŸ¥è¯¢çš„æ ¸å¿ƒé—®é¢˜ï¼Œä½†å¼•å…¥äº†æ–°çš„å®‰å…¨é£é™©å’Œç«æ€æ¡ä»¶ã€‚å»ºè®®ä¼˜å…ˆä¿®å¤æ•æ„Ÿä¿¡æ¯æ³„éœ²å’Œå¹¶å‘å®‰å…¨é—®é¢˜ã€‚